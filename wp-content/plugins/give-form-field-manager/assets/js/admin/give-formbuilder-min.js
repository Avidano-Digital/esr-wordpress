/**
 * Form Field Builder - JS
 *
 * Handles form builder client side (JS) functionality.
 *
 * @package     Give_FFM
 * @copyright   Copyright (c) 2015, WordImpress
 * @license     http://opensource.org/licenses/gpl-2.0.php GNU Public License
 * @since       1.0
 */
!function($){var e=$("ul#give-form-fields-editor"),t={init:function(){this.makeSortable(),$("button.ffm-collapse").on("click",this.collapseEditFields),$(".give-form-fields-buttons").on("click","button",this.addNewField),$("#give-form-fields-editor").on("click",".item-delete",this.removeFormField),$("#give-form-fields-editor").on("blur",".js-ffm-field-label",this.setMetaKey),$("#give-form-fields-editor").on("blur",".js-ffm-meta-key",this.setMetaKey),$("#give-form-fields-editor").on("blur",".js-ffm-meta-key",this.checkDuplicateMetaKeys),$("#give-form-fields-editor").on("change",".give-form-fields-sub-fields input[type=text]",function(){$(this).prev("input[type=checkbox], input[type=radio]").val($(this).val())}),$("#give-form-fields-editor").on("click","input[type=checkbox].multicolumn",function(){var e=$(this),t=e.closest(".give-form-fields-rows");e.is(":checked")?(t.next().hide().next().hide(),t.siblings(".column-names").show()):(t.next().show().next().show(),t.siblings(".column-names").hide())}),$("#give-form-fields-editor").on("click",".ffm-clone-field",this.cloneField),$("#give-form-fields-editor").on("click",".ffm-remove-field",this.removeField)},makeSortable:function(){(e=$("ul#give-form-fields-editor"))&&e.sortable({placeholder:"sortable-placeholder",handle:"> .ffm-legend",distance:5})},addNewField:function(e){e.preventDefault(),$(".ffm-loading").fadeIn();var i=$(this),l=$("ul#give-form-fields-editor"),o=$("#ffm-metabox-editor"),f=i.data("name"),a=i.data("type"),s={name:f,type:a,order:l.find("li").length+1,action:"give-form-fields_add_el"};$.post(ajaxurl,s,function(e){l.append(e),t.makeSortable(),$(".ffm-loading").fadeOut(),$(".ffm-no-fields").hide(),t.tooltips()})},removeFormField:function(e){e.preventDefault(),confirm("Are you sure you want to remove this form field?")&&$(this).closest("li").fadeOut(function(){$(this).remove()})},cloneField:function(e){e.preventDefault();var t=$(this).closest("div"),i=t.clone();i.find("input").val(""),i.find(":checked").attr("checked",""),t.after(i)},removeField:function(){var e=$(this).closest("div");e.siblings().andSelf().length>1&&e.remove()},setMetaKey:function(){var e=$(this);if(e.hasClass("js-ffm-field-label"))$fieldLabel=e,$metaKey=e.closest(".give-form-fields-rows").next().find(".js-ffm-meta-key");else{if(!e.hasClass("js-ffm-meta-key"))return!1;$fieldLabel=e.closest(".give-form-fields-rows").prev().find(".js-ffm-field-label"),$metaKey=e}$metaKey.length&&!$metaKey.val()&&(val=$fieldLabel.val().trim().toLowerCase().replace(/[\s\-]/g,"_").replace(/[^a-z0-9_]/g,""),val.length>200&&(val=val.substring(0,200)),$metaKey.val(val))},collapseEditFields:function(e){e.preventDefault(),$("ul#give-form-fields-editor").children("li").find(".collapse").collapse("toggle")},tooltips:function(){jQuery('[data-tooltip!=""]').qtip({content:{attr:"data-tooltip"},style:{classes:"qtip-rounded qtip-tipsy"},position:{my:"bottom center",at:"top center"}})},checkDuplicateMetaKeys:function(e){if($metaKey=$(e.target),justChecked=$metaKey.data("justChecked"),""!==$metaKey.val()){if(justChecked)return void $metaKey.data("justChecked",!1);for(var t=$("#give-form-fields-editor").find(".js-ffm-meta-key").map(function(){return $(this).val()}).sort(),i=0;i<t.length-1;i++)if(t[i+1]==t[i]&&t[i].length)return $metaKey.data("justChecked",!0),alert(give_ffm_formbuilder.error_duplicate_meta),void setTimeout(function(){$metaKey.data("justChecked",!1),$metaKey.focus()},50)}}};$(function(){t.init()})}(jQuery);